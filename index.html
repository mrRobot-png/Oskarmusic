<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Wallet Pro â€” Smarter</title>
<style>
    :root {
        --bg: #0f1220;
        --card: rgba(255,255,255,0.08);
        --muted: #a0a3bd;
        --accent: #4aa3ff;
        --green: #2ecc71;
        --red: #ff5c5c;
        --yellow: #f1c40f;
        --radius: 14px;
        --maxw: 700px;
    }
    html,body{height:100%;margin:0}
    body {
        background: var(--bg);
        color: #eaeaf0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        padding: 22px;
        display:flex;
        justify-content:center;
        align-items:flex-start;
    }
    .wrap {
        width:100%;
        max-width:var(--maxw);
    }
    .card {
        background: var(--card);
        border-radius: var(--radius);
        padding:16px;
        margin-bottom:14px;
        border:1px solid rgba(255,255,255,0.12);
    }
    h2,h3{margin:0 0 8px;color:var(--accent)}
    .muted{color:var(--muted);font-size:0.9rem}
    .balance {
        font-size:2.2rem;font-weight:700;color:var(--green);
        display:flex;justify-content:space-between;align-items:center;
    }
    .small-btn { padding:6px 10px;border-radius:10px;border:none; cursor:pointer; font-weight:600 }
    .blue { background:var(--accent); color:white }
    .green { background:var(--green); color:#082a12 }
    .red { background:var(--red); color:white }
    input[type="text"], input[type="number"], select {
        width:100%; padding:12px; margin-top:8px; border-radius:10px;
        background: rgba(255,255,255,0.04); color: #fff; border:1px solid rgba(255,255,255,0.12);
        box-sizing:border-box; font-size:1rem;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .progress-container { background: rgba(255,255,255,0.06); border-radius:10px; height:12px; overflow:hidden; margin-top:10px;}
    .progress-bar { height:100%; width:0%; transition:width .25s, background .25s; }
    ul { list-style:none;padding:0;margin:0; max-height:220px; overflow:auto;}
    li { padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .note { color:var(--muted); font-size:0.85rem }
    .floating {
        position:fixed; right:20px; bottom:20px; z-index:9999;
        display:flex; gap:8px; flex-direction:column;
    }
    .chip { padding:8px 12px; border-radius:999px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); }
    .controls { display:flex; gap:10px; margin-top:10px; }
    .filter-row { display:flex; gap:10px; align-items:center; margin-top:8px }
    .small { font-size:0.85rem; padding:6px 10px; border-radius:8px; }
    .danger { background: rgba(255,0,0,0.06); border:1px solid rgba(255,0,0,0.12); color:var(--red); padding:8px;border-radius:10px }
    .center { text-align:center }
    .kbd { background:rgba(0,0,0,0.25); padding:2px 6px; border-radius:6px; font-size:0.8rem; }
    .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center; }
    .modal-overlay.active { display:flex; }
    .modal-content { background:var(--bg); border:1px solid rgba(255,255,255,0.12); border-radius:var(--radius); padding:24px; max-width:400px; width:90%; }
    .modal-content h3 { margin-top:0; }
    .modal-content button { width:100%; margin-top:10px; padding:10px; }
    @media (max-width:520px){ .row{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <div class="muted">Current Balance</div>
                <div class="balance" id="balanceText">Rp 0</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;min-width:180px">
                <button class="small-btn blue" id="snapshotBtn">Take Snapshot</button>
                <button class="small-btn green" id="quickAddBtn">Quick + Balance</button>
            </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <div class="chip muted">Last change: <span id="lastChange">â€”</span></div>
            <div class="chip muted">Entries: <span id="entryCount">0</span></div>
            <div class="chip muted">Undo: <span id="canUndo">No</span></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <div class="chip muted">Carried Over: <span id="carryover">Rp 0</span></div>
            <div class="chip muted">Target Days: <span id="targetDaysDisplay">â€”</span></div>
        </div>
    </div>

    <div class="card">
        <h3>Target Maker</h3>
        <p class="muted">How many days must this money last?</p>
        <div class="row">
            <input type="number" id="targetDays" placeholder="e.g. 9">
            <select id="targetMode" title="target mode">
                <option value="days">Days (divide total)</option>
                <option value="monthly">Months (divide total * 30)</option>
            </select>
        </div>
        <button class="small-btn blue" id="saveTargetBtn" style="width:100%; margin-top:10px;">Save Target Days</button>
        <div id="targetDisplay" class="target-result" style="display:none; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end">
                <span class="muted">Daily Budget: <br><strong id="dailyLimit" style="color:var(--accent); font-size:1.05rem">Rp 0</strong></span>
                <span id="warningText" class="muted" style="font-weight:700"></span>
            </div>
            <div class="progress-container">
                <div id="pBar" class="progress-bar"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:8px;" class="muted">
                <span>Spent Today: <span id="spentToday">Rp 0</span></span>
                <span>Remaining Today: <span id="remainingToday">Rp 0</span></span>
            </div>
            <div style="margin-top:8px; padding:8px; background:rgba(74,163,255,0.1); border-radius:8px; color:var(--accent);">
                <strong>Carryover Applied:</strong> <span id="carryoverApplied">Rp 0</span>
            </div>
        </div>
    </div>

    <div class="card" aria-labelledby="addTransactionTitle">
        <h3 id="addTransactionTitle">Add Transaction</h3>
        <div class="row">
            <input type="text" id="amount" inputmode="numeric" placeholder="Amount (e.g. 20.000)" autocomplete="off" />
            <input type="text" id="note" placeholder="Description (optional)" autocomplete="off" />
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="green" id="btnIncome">Income</button>
            <button class="red" id="btnExpense">Expense</button>
            <button class="small-btn blue" id="btnUndo" title="Undo last transaction">Undo</button>
        </div>

        <div class="controls" style="margin-top:12px">
            <button class="small-btn" id="btnExport">Export CSV</button>
            <button class="small-btn" id="btnExportJSON">Export JSON</button>
            <input type="file" id="importFile" style="display:none;" accept=".json" />
            <button class="small-btn" id="btnImport">Import JSON</button>
        </div>
    </div>

    <div class="card">
        <h3>Activity Log</h3>
        <div class="filter-row">
            <select id="filterType">
                <option value="all">All</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
                <option value="Snapshot">Snapshot</option>
            </select>
            <input type="date" id="filterFrom" />
            <input type="date" id="filterTo" />
            <button class="small-btn" id="btnApplyFilter">Apply</button>
            <button class="small-btn" id="btnClearFilter">Clear</button>
        </div>
        <ul id="historyList"></ul>
    </div>

    <div class="card" id="adminSection">
        <h3>Admin Panel <span class="muted">(unlocked)</span></h3>
        <div class="muted">Reset balance (type number with separators allowed)</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
            <input id="balanceInput" placeholder="New Balance value"/>
            <button class="blue" id="setBalanceBtn">Overwrite</button>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
            <button class="small-btn red" id="clearAllBtn">Clear all data</button>
            <button class="small-btn" id="downloadLogsBtn">Download logs (JSON)</button>
        </div>
    </div>

</div>

<!-- Modal for payday prompt -->
<div class="modal-overlay" id="paydayModal">
    <div class="modal-content">
        <h3>New Payday Detected! ðŸ’°</h3>
        <p class="muted">You've added a significant balance. How many days should this last?</p>
        <input type="number" id="paydayDays" placeholder="e.g. 14" min="1" />
        <select id="paydayMode">
            <option value="days">Days</option>
            <option value="monthly">Months</option>
        </select>
        <button class="blue" id="paydayConfirmBtn">Confirm</button>
        <button class="small-btn" id="paydaySkipBtn">Skip</button>
    </div>
</div>

<div class="floating" aria-hidden="false">
    <button id="floatingAdd" class="green small-btn">ï¼‹ Add Quick Income</button>
    <button id="floatingToggleAdmin" class="small-btn">Toggle Admin</button>
</div>
<script>
/* ---------------------------
   Smart Daily Wallet Pro JS
   - Accepts 20.000 / 20,000 / 20000
   - Activity log, snapshots, undo, export/import
   - Persistent localStorage with carryover system
   - Auto-format input, notifications for over-limit
   - NEW: Carryover system + permanent target days
   - NEW: Payday detection (balance > 100000)
---------------------------- */

(() => {
    // Keys
    const LS_BALANCE = 'dwp_balance_v2';
    const LS_HISTORY = 'dwp_history_v2';
    const LS_TARGET_DAYS = 'dwp_target_days_v2';
    const LS_TARGET_MODE = 'dwp_target_mode_v2';
    const LS_LAST_UNDO = 'dwp_last_undo_v2';
    const LS_CARRYOVER = 'dwp_carryover_v2';
    const LS_LAST_CARRYOVER_DATE = 'dwp_last_carryover_date_v2';

    // Elements
    const balanceText = el('balanceText');
    const lastChange = el('lastChange');
    const entryCount = el('entryCount');
    const canUndoEl = el('canUndo');
    const carryoverEl = el('carryover');
    const targetDaysDisplay = el('targetDaysDisplay');
    const amountInput = el('amount');
    const noteInput = el('note');
    const btnIncome = el('btnIncome');
    const btnExpense = el('btnExpense');
    const btnUndo = el('btnUndo');
    const historyList = el('historyList');
    const targetDaysInput = el('targetDays');
    const targetMode = el('targetMode');
    const targetDisplay = el('targetDisplay');
    const dailyLimitEl = el('dailyLimit');
    const spentTodayEl = el('spentToday');
    const remainingTodayEl = el('remainingToday');
    const pBar = el('pBar');
    const warningText = el('warningText');
    const carryoverAppliedEl = el('carryoverApplied');
    const snapshotBtn = el('snapshotBtn');
    const quickAddBtn = el('quickAddBtn');
    const quickFloating = el('floatingAdd');
    const btnExport = el('btnExport');
    const btnExportJSON = el('btnExportJSON');
    const btnImport = el('btnImport');
    const importFile = el('importFile');
    const filterType = el('filterType');
    const filterFrom = el('filterFrom');
    const filterTo = el('filterTo');
    const btnApplyFilter = el('btnApplyFilter');
    const btnClearFilter = el('btnClearFilter');
    const setBalanceBtn = el('setBalanceBtn');
    const balanceInput = el('balanceInput');
    const clearAllBtn = el('clearAllBtn');
    const downloadLogsBtn = el('downloadLogsBtn');
    const saveTargetBtn = el('saveTargetBtn');
    const paydayModal = el('paydayModal');
    const paydayDays = el('paydayDays');
    const paydayMode = el('paydayMode');
    const paydayConfirmBtn = el('paydayConfirmBtn');
    const paydaySkipBtn = el('paydaySkipBtn');

    // State
    let balance = loadNumber(LS_BALANCE, 0);
    let history = loadJSON(LS_HISTORY, []);
    let lastUndo = loadJSON(LS_LAST_UNDO, null);
    let carryover = loadNumber(LS_CARRYOVER, 0);
    let targetDays = loadNumber(LS_TARGET_DAYS, 0);
    let targetModeValue = localStorage.getItem(LS_TARGET_MODE) || 'days';

    // Initialize UI with saved values
    targetDaysInput.value = targetDays || '';
    targetMode.value = targetModeValue;

    // Initialize event listeners
    amountInput.addEventListener('input', onAmountInput);
    amountInput.addEventListener('keydown', onAmountKeyDown);
    btnIncome.addEventListener('click', () => addTransaction('Income'));
    btnExpense.addEventListener('click', () => addTransaction('Expense'));
    btnUndo.addEventListener('click', undoLast);
    snapshotBtn.addEventListener('click', takeSnapshot);
    quickAddBtn.addEventListener('click', quickAddModal);
    quickFloating.addEventListener('click', quickAddModal);
    btnExport.addEventListener('click', exportCSV);
    btnExportJSON.addEventListener('click', () => downloadJSON(history, 'dwp_history.json'));
    btnImport.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', handleImport);
    btnApplyFilter.addEventListener('click', applyFilter);
    btnClearFilter.addEventListener('click', clearFilter);
    setBalanceBtn.addEventListener('click', setBalanceFromAdmin);
    balanceInput.addEventListener('input', onAdminBalanceInput);
    clearAllBtn.addEventListener('click', clearAllData);
    downloadLogsBtn.addEventListener('click', () => downloadJSON(history, 'dwp_history.json'));
    targetMode.addEventListener('change', () => {
        targetModeValue = targetMode.value;
        localStorage.setItem(LS_TARGET_MODE, targetModeValue);
        updateUI();
    });
    saveTargetBtn.addEventListener('click', saveTargetDays);
    paydayConfirmBtn.addEventListener('click', confirmPayday);
    paydaySkipBtn.addEventListener('click', skipPayday);

    // Check and apply carryover from previous day
    applyCarryoverIfNewDay();

    // Render initial UI
    updateUI();

    // ---------------- Helpers ----------------
    function el(id) { return document.getElementById(id); }

    function loadJSON(key, fallback) {
        try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback }
        catch(e){ return fallback }
    }
    function saveJSON(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    function loadNumber(key, fallback) {
        const v = localStorage.getItem(key);
        return v === null ? fallback : Number(v);
    }
    function saveNumber(key, value) { localStorage.setItem(key, String(value)); }

    function nowKey(d = new Date()) {
        return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    }
    function nowTime(d = new Date()){
        return d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
    }
    function displayDateTime(d = new Date()){
        return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${nowTime(d)}`;
    }

    // Parse input like "20.000", "20,000" or "20000" to integer
    function parseRupiah(input) {
        if (input === undefined || input === null) return NaN;
        let s = String(input).trim();
        s = s.replace(/[^\d]/g,'');
        return s === '' ? NaN : Number(s);
    }

    function formatRupiah(num) {
        if (isNaN(num) || num === null) return '0';
        return Number(num).toLocaleString('id-ID');
    }

    function onAmountInput(e) {
        const raw = e.target.value;
        const numeric = raw.replace(/[^\d]/g,'');
        if (numeric === '') { e.target.value=''; return; }
        const formatted = formatRupiah(Number(numeric));
        e.target.value = formatted;
    }

    function onAdminBalanceInput(e) {
        onAmountInput(e);
    }

    function onAmountKeyDown(e){
        if (e.key === 'Enter') addTransaction('Expense');
    }

    // Add transaction with carryover check
    function addTransaction(type) {
        const amtRaw = amountInput.value;
        const amount = parseRupiah(amtRaw);
        const note = (noteInput.value || '').trim() || (type === 'Income' ? 'Income' : 'Expense');

        if (isNaN(amount) || amount <= 0) { alert('Enter a valid amount'); return; }

        const t = {
            id: Date.now(),
            type,
            amount,
            note,
            timestamp: new Date().toISOString(),
            dateKey: nowKey(),
            fullDate: displayDateTime()
        };

        lastUndo = { action: 'add', transaction: t, prevBalance: balance };
        saveJSON(LS_LAST_UNDO, lastUndo);

        balance = balance + (type === 'Income' ? amount : -amount);

        history.push(t);
        persistAll();
        amountInput.value = '';
        noteInput.value = '';
        updateUI();

        // Check for payday (income > 100000)
        if (type === 'Income' && amount > 100000) {
            showPaydayModal();
        }
    }

    // Undo last action
    function undoLast() {
        const undo = loadJSON(LS_LAST_UNDO, null);
        if (!undo) { alert('No action to undo'); return; }

        if (undo.action === 'add') {
            const tid = undo.transaction.id;
            const idx = history.findIndex(h => h.id === tid);
            if (idx > -1) history.splice(idx,1);
            balance = undo.prevBalance;
            lastUndo = null;
            persistAll();
            updateUI();
            alert('Last transaction undone');
            return;
        }
        alert('Nothing undone');
    }

    // Snapshot (balance checkpoint)
    function takeSnapshot() {
        const t = {
            id: Date.now(),
            type: 'Snapshot',
            amount: balance,
            note: 'Snapshot',
            timestamp: new Date().toISOString(),
            dateKey: nowKey(),
            fullDate: displayDateTime()
        };
        history.push(t);
        saveJSON(LS_HISTORY, history);
        updateUI();
        alert('Snapshot recorded');
    }

    // Quick add modal (simple prompt)
    function quickAddModal() {
        const v = prompt('Quick add amount (e.g. 50.000)');
        if (!v) return;
        const amount = parseRupiah(v);
        if (isNaN(amount) || amount <= 0) { alert('Invalid amount'); return; }
        const t = {
            id: Date.now(),
            type: 'Income',
            amount,
            note: 'Quick Add',
            timestamp: new Date().toISOString(),
            dateKey: nowKey(),
            fullDate: displayDateTime()
        };
        lastUndo = { action:'add', transaction: t, prevBalance: balance };
        saveJSON(LS_LAST_UNDO, lastUndo);
        balance += amount;
        history.push(t);
        persistAll();
        updateUI();

        if (amount > 100000) {
            showPaydayModal();
        }
    }

    // Export CSV
    function exportCSV() {
        if (!history.length) { alert('No logs to export'); return; }
        const header = ['id','type','amount','note','fullDate','timestamp'];
        const rows = history.map(h => [h.id,h.type,h.amount, `"${(h.note||'').replace(/"/g,'""')}"`, h.fullDate, h.timestamp]);
        const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
        downloadFile(csv, 'text/csv', `dwp_history_${Date.now()}.csv`);
    }

    function downloadJSON(obj, filename='data.json') {
        const text = JSON.stringify(obj, null, 2);
        downloadFile(text, 'application/json', filename)
            }

    function downloadFile(text, mime, filename) {
        const b = new Blob([text], {type:mime});
        const url = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // Import JSON
    function handleImport(e) {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const parsed = JSON.parse(reader.result);
                if (!Array.isArray(parsed)) throw new Error('Expected an array of history items');
                const existingIds = new Set(history.map(h=>h.id));
                parsed.forEach(item => {
                    if (!existingIds.has(item.id)) history.push(item);
                });
                persistAll();
                updateUI();
                alert('Import complete');
            } catch(err) {
                alert('Import failed: ' + err.message);
            }
        };
        reader.readAsText(f);
        importFile.value = '';
    }

    // Filtering UI
    function applyFilter() {
        const type = filterType.value;
        const from = filterFrom.value ? new Date(filterFrom.value) : null;
        const to = filterTo.value ? new Date(filterTo.value) : null;
        const filtered = history.filter(h => {
            if (type !== 'all' && h.type !== type) return false;
            const dt = new Date(h.timestamp);
            if (from && dt < from) return false;
            if (to) {
                const toEnd = new Date(to); toEnd.setHours(23,59,59,999);
                if (dt > toEnd) return false;
            }
            return true;
        });
        renderHistory(filtered);
    }
    function clearFilter() {
        filterType.value = 'all';
        filterFrom.value = '';
        filterTo.value = '';
        renderHistory(history.slice().reverse());
    }

    // Admin functions
    function setBalanceFromAdmin() {
        const val = balanceInput.value;
        const parsed = parseRupiah(val);
        if (isNaN(parsed)) { alert('Invalid number'); return; }
        if (!confirm('Overwrite balance? This will be recorded as an admin snapshot.')) return;
        const before = {
            id: Date.now()+1,
            type: 'Snapshot',
            amount: parsed,
            note: 'Admin overwrite',
            timestamp: new Date().toISOString(),
            dateKey: nowKey(),
            fullDate: displayDateTime()
        };
        lastUndo = null;
        balance = parsed;
        history.push(before);
        persistAll();
        balanceInput.value = '';
        updateUI();
        alert('Balance overwritten & snapshot recorded');
    }

    function clearAllData() {
        if (!confirm('Clear everything (balance, logs, target days)?')) return;
        localStorage.removeItem(LS_BALANCE);
        localStorage.removeItem(LS_HISTORY);
        localStorage.removeItem(LS_TARGET_DAYS);
        localStorage.removeItem(LS_TARGET_MODE);
        localStorage.removeItem(LS_LAST_UNDO);
        localStorage.removeItem(LS_CARRYOVER);
<script>
(() => {
  /* =====================
     CONSTANTS & STORAGE
  ====================== */
  const LS_HISTORY = 'dwp_history_v3';
  const LS_TARGET_DAYS = 'dwp_target_days_v3';
  const LS_TARGET_MODE = 'dwp_target_mode_v3';
  const LS_CARRYOVER = 'dwp_carryover_v3';
  const LS_LAST_DATE = 'dwp_last_date_v3';
  const LS_LAST_UNDO = 'dwp_last_undo_v3';

  /* =====================
     HELPERS
  ====================== */
  const el = id => document.getElementById(id);
  const todayKey = d => {
    const x = d || new Date();
    return `${x.getFullYear()}-${x.getMonth()+1}-${x.getDate()}`;
  };
  const format = n => Number(n || 0).toLocaleString('id-ID');
  const parse = v => {
    if (!v) return NaN;
    const s = String(v).replace(/[^\d]/g,'');
    return s ? Number(s) : NaN;
  };

  /* =====================
     LOAD STATE
  ====================== */
  let history = JSON.parse(localStorage.getItem(LS_HISTORY) || '[]');
  let targetDays = Number(localStorage.getItem(LS_TARGET_DAYS) || 0);
  let targetMode = localStorage.getItem(LS_TARGET_MODE) || 'days';
  let carryover = Number(localStorage.getItem(LS_CARRYOVER) || 0);
  let lastDate = localStorage.getItem(LS_LAST_DATE) || todayKey();
  let lastUndo = JSON.parse(localStorage.getItem(LS_LAST_UNDO) || 'null');

  /* =====================
     DERIVED STATE
  ====================== */
  function computeBalance() {
    return history.reduce((sum,h)=>{
      if (h.type === 'Income') return sum + h.amount;
      if (h.type === 'Expense') return sum - h.amount;
      return sum;
    },0);
  }

  function dailyLimit(balance) {
    if (!targetDays) return 0;
    const d = targetMode === 'monthly' ? targetDays * 30 : targetDays;
    return Math.max(1, Math.floor(balance / d));
  }

  /* =====================
     CARRYOVER (FIXED)
  ====================== */
  function applyCarryover() {
    const today = todayKey();
    if (today === lastDate) return;

    const yesterday = lastDate;
    const balanceAtEnd = computeBalance();
    const limit = dailyLimit(balanceAtEnd);

    const spent = history
      .filter(h => h.type === 'Expense' && h.dateKey === yesterday)
      .reduce((s,h)=>s+h.amount,0);

    carryover = Math.max(0, limit - spent);
    lastDate = today;

    persist();
  }

  /* =====================
     PERSIST
  ====================== */
  function persist() {
    localStorage.setItem(LS_HISTORY, JSON.stringify(history));
    localStorage.setItem(LS_TARGET_DAYS, targetDays);
    localStorage.setItem(LS_TARGET_MODE, targetMode);
    localStorage.setItem(LS_CARRYOVER, carryover);
    localStorage.setItem(LS_LAST_DATE, lastDate);
    localStorage.setItem(LS_LAST_UNDO, JSON.stringify(lastUndo));
  }

  /* =====================
     TRANSACTIONS
  ====================== */
  function addTransaction(type) {
    const amt = parse(el('amount').value);
    if (!amt || amt <= 0) return alert('Invalid amount');

    const tx = {
      id: Date.now(),
      type,
      amount: amt,
      note: el('note').value || type,
      dateKey: todayKey(),
      fullDate: new Date().toLocaleString('id-ID')
    };

    history.push(tx);
    lastUndo = { action:'add', tx };
    persist();
    updateUI();

    el('amount').value = '';
    el('note').value = '';

    if (type === 'Income' && amt >= computeBalance()*0.5) {
      showPayday();
    }
  }

  function undo() {
    if (!lastUndo) return alert('Nothing to undo');

    if (lastUndo.action === 'add') {
      history = history.filter(h => h.id !== lastUndo.tx.id);
    }

    lastUndo = null;
    persist();
    updateUI();
  }

  function deleteLog(id) {
    const tx = history.find(h=>h.id===id);
    if (!tx) return;

    history = history.filter(h=>h.id!==id);
    lastUndo = { action:'delete', tx };
    persist();
    updateUI();
  }

  window.deleteLog = deleteLog;

  /* =====================
     SNAPSHOT (SAFE)
  ====================== */
  function snapshot() {
    history.push({
      id: Date.now(),
      type: 'Snapshot',
      amount: 0,
      note: 'Snapshot',
      dateKey: todayKey(),
      fullDate: new Date().toLocaleString('id-ID')
    });
    persist();
    updateUI();
  }

  /* =====================
     PAYDAY MODAL
  ====================== */
  function showPayday() {
    el('paydayModal').classList.add('active');
  }
  function confirmPayday() {
    const d = Number(el('paydayDays').value);
    if (!d || d <= 0) return alert('Invalid days');
    targetDays = d;
    targetMode = el('paydayMode').value;
    persist();
    el('paydayModal').classList.remove('active');
    updateUI();
  }
  function skipPayday() {
    el('paydayModal').classList.remove('active');
  }

  /* =====================
     UI
  ====================== */
  function updateUI() {
    const balance = computeBalance();
    el('balanceText').innerText = `Rp ${format(balance)}`;
    el('entryCount').innerText = history.length;
    el('canUndo').innerText = lastUndo ? 'Yes' : 'No';
    el('carryover').innerText = `Rp ${format(carryover)}`;
    el('targetDaysDisplay').innerText =
      targetDays ? `${targetDays} ${targetMode}(s)` : 'â€”';

    renderHistory();
    renderBudget(balance);
  }

  function renderHistory() {
    el('historyList').innerHTML =
      history.slice().reverse().map(h=>`
        <li>
          <div>
            <strong>${h.type}</strong>
            <div class="note">${h.fullDate} â€¢ ${h.note}</div>
          </div>
          <div style="text-align:right">
            ${h.type==='Expense'?'âˆ’':h.type==='Income'?'+':''}
            Rp ${format(h.amount)}
            <div>
              <button class="small-btn" onclick="deleteLog(${h.id})">Delete</button>
            </div>
          </div>
        </li>
      `).join('');
  }

  function renderBudget(balance) {
    if (!targetDays) {
      el('targetDisplay').style.display='none';
      return;
    }

    applyCarryover();

    const limit = dailyLimit(balance) + carryover;
    const spent = history
      .filter(h=>h.type==='Expense' && h.dateKey===todayKey())
      .reduce((s,h)=>s+h.amount,0);

    const pct = Math.min(100, (spent/limit)*100 || 0);

    el('targetDisplay').style.display='block';
    el('dailyLimit').innerText = `Rp ${format(limit)}`;
    el('spentToday').innerText = `Rp ${format(spent)}`;
    el('remainingToday').innerText = `Rp ${format(Math.max(0,limit-spent))}`;
    el('pBar').style.width = pct+'%';
  }

  /* =====================
     EVENTS
  ====================== */
  el('btnIncome').onclick = ()=>addTransaction('Income');
  el('btnExpense').onclick = ()=>addTransaction('Expense');
  el('btnUndo').onclick = undo;
  el('snapshotBtn').onclick = snapshot;
  el('paydayConfirmBtn').onclick = confirmPayday;
  el('paydaySkipBtn').onclick = skipPayday;

  updateUI();
})();
</script>
</body>
</html>
