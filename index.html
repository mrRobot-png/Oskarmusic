<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Wallet Pro â€” Smarter (Option C)</title>
<style>
    :root {
        --bg: #0f1220;
        --card: rgba(255,255,255,0.08);
        --muted: #a0a3bd;
        --accent: #4aa3ff;
        --green: #2ecc71;
        --red: #ff5c5c;
        --yellow: #f1c40f;
        --radius: 14px;
        --maxw: 700px;
    }
    html,body{height:100%;margin:0}
    body {
        background: var(--bg);
        color: #eaeaf0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        padding: 22px;
        display:flex;
        justify-content:center;
        align-items:flex-start;
    }
    .wrap {
        width:100%;
        max-width:var(--maxw);
    }
    .card {
        background: var(--card);
        border-radius: var(--radius);
        padding:16px;
        margin-bottom:14px;
        border:1px solid rgba(255,255,255,0.12);
    }
    h2,h3{margin:0 0 8px;color:var(--accent)}
    .muted{color:var(--muted);font-size:0.9rem}
    .balance {
        font-size:2.2rem;font-weight:700;color:var(--green);
        display:flex;justify-content:space-between;align-items:center;
    }
    .small-btn { padding:6px 10px;border-radius:10px;border:none; cursor:pointer; font-weight:600 }
    .blue { background:var(--accent); color:white }
    .green { background:var(--green); color:#082a12 }
    .red { background:var(--red); color:white }
    input[type="text"], input[type="number"], select {
        width:100%; padding:12px; margin-top:8px; border-radius:10px;
        background: rgba(255,255,255,0.04); color: #fff; border:1px solid rgba(255,255,255,0.12);
        box-sizing:border-box; font-size:1rem;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .progress-container { background: rgba(255,255,255,0.06); border-radius:10px; height:12px; overflow:hidden; margin-top:10px;}
    .progress-bar { height:100%; width:0%; transition:width .25s, background .25s; }
    ul { list-style:none;padding:0;margin:0; max-height:220px; overflow:auto;}
    li { padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .note { color:var(--muted); font-size:0.85rem }
    .floating {
        position:fixed; right:20px; bottom:20px; z-index:9999;
        display:flex; gap:8px; flex-direction:column;
    }
    .chip { padding:8px 12px; border-radius:999px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); }
    .controls { display:flex; gap:10px; margin-top:10px; }
    .filter-row { display:flex; gap:10px; align-items:center; margin-top:8px }
    .small { font-size:0.85rem; padding:6px 10px; border-radius:8px; }
    .danger { background: rgba(255,0,0,0.06); border:1px solid rgba(255,0,0,0.12); color:var(--red); padding:8px;border-radius:10px }
    .center { text-align:center }
    .kbd { background:rgba(0,0,0,0.25); padding:2px 6px; border-radius:6px; font-size:0.8rem; }
    .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center; }
    .modal-overlay.active { display:flex; }
    .modal-content { background:var(--bg); border:1px solid rgba(255,255,255,0.12); border-radius:var(--radius); padding:24px; max-width:400px; width:90%; }
    .modal-content h3 { margin-top:0; }
    .modal-content button { width:100%; margin-top:10px; padding:10px; }
    @media (max-width:520px){ .row{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <div class="muted">Current Balance</div>
                <div class="balance" id="balanceText">Rp 0</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;min-width:180px">
                <button class="small-btn blue" id="snapshotBtn">Take Snapshot</button>
                <button class="small-btn green" id="quickAddBtn">Quick + Balance</button>
            </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <div class="chip muted">Last change: <span id="lastChange">â€”</span></div>
            <div class="chip muted">Entries: <span id="entryCount">0</span></div>
            <div class="chip muted">Undo: <span id="canUndo">No</span></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <div class="chip muted">Daily Limit: <span id="dailyLimitDisplay">â€”</span></div>
            <div class="chip muted">Carryover: <span id="carryover">Rp 0</span></div>
        </div>
    </div>

    <div class="card">
        <h3>Target Maker (Adaptive)</h3>
        <p class="muted">How many days must this money last? The app will adapt based on your real spending.</p>
        <div class="row">
            <input type="number" id="targetDays" placeholder="e.g. 9">
            <select id="targetMode" title="target mode">
                <option value="days">Days (divide total)</option>
                <option value="monthly">Months (divide total * 30)</option>
            </select>
        </div>
        <button class="small-btn blue" id="saveTargetBtn" style="width:100%; margin-top:10px;">Save Target Days</button>
        <div id="targetDisplay" class="target-result" style="display:none; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end">
                <div>
                    <span class="muted">Today's Budget: <br><strong id="dailyBudget" style="color:var(--accent); font-size:1.05rem">Rp 0</strong></span>
                </div>
                <div style="text-align:right">
                    <div class="muted" style="font-size:0.9rem">Original Target: <span id="origTarget">â€”</span></div>
                    <div class="muted" style="font-size:1rem; margin-top:6px">Estimate Remaining Days: <strong id="remainingDaysEstimate">â€”</strong></div>
                    <div id="warningText" class="muted" style="font-weight:700; margin-top:6px;"></div>
                </div>
            </div>
            <div class="progress-container">
                <div id="pBar" class="progress-bar"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:8px;" class="muted">
                <span>Spent Today: <span id="spentToday">Rp 0</span></span>
                <span>Remaining Today: <span id="remainingToday">Rp 0</span></span>
            </div>
            <div style="margin-top:8px" class="muted">Target started: <span id="targetStartDate">â€”</span></div>
        </div>
    </div>

    <div class="card" aria-labelledby="addTransactionTitle">
        <h3 id="addTransactionTitle">Add Transaction</h3>
        <div class="row">
            <input type="text" id="amount" inputmode="numeric" placeholder="Amount (e.g. 20.000)" autocomplete="off" />
            <input type="text" id="note" placeholder="Description (optional)" autocomplete="off" />
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="green" id="btnIncome">Income</button>
            <button class="red" id="btnExpense">Expense</button>
            <button class="small-btn blue" id="btnUndo" title="Undo last transaction">Undo</button>
        </div>

        <div class="controls" style="margin-top:12px">
            <button class="small-btn" id="btnExport">Export CSV</button>
            <button class="small-btn" id="btnExportJSON">Export JSON</button>
            <input type="file" id="importFile" style="display:none;" accept=".json" />
            <button class="small-btn" id="btnImport">Import JSON</button>
        </div>
    </div>

    <div class="card">
        <h3>Activity Log</h3>
        <div class="filter-row">
            <select id="filterType">
                <option value="all">All</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
                <option value="Snapshot">Snapshot</option>
            </select>
            <input type="date" id="filterFrom" />
            <input type="date" id="filterTo" />
            <button class="small-btn" id="btnApplyFilter">Apply</button>
            <button class="small-btn" id="btnClearFilter">Clear</button>
        </div>
        <ul id="historyList"></ul>
    </div>

    <div class="card" id="adminSection" style="display:none;">
        <h3>Admin Panel <span class="muted">(unlocked)</span></h3>
        <div class="muted">Reset balance (type number with separators allowed)</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
            <input id="balanceInput" placeholder="New Balance value"/>
            <button class="blue" id="setBalanceBtn">Overwrite</button>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
            <button class="small-btn red" id="clearAllBtn">Clear all data</button>
            <button class="small-btn" id="downloadLogsBtn">Download logs (JSON)</button>
        </div>
    </div>

</div>

<div class="modal-overlay" id="paydayModal">
    <div class="modal-content">
        <h3>New Payday Detected! ðŸ’°</h3>
        <p class="muted">You've added a significant balance. How many days should this last?</p>
        <input type="number" id="paydayDays" placeholder="e.g. 14" min="1" />
        <select id="paydayMode">
            <option value="days">Days</option>
            <option value="monthly">Months</option>
        </select>
        <button class="blue" id="paydayConfirmBtn">Confirm</button>
        <button class="small-btn" id="paydaySkipBtn">Skip</button>
    </div>
</div>

<div class="floating" aria-hidden="false">
    <button id="floatingAdd" class="green small-btn">ï¼‹ Add Quick Income</button>
    <button id="floatingToggleAdmin" class="small-btn">Toggle Admin</button>
</div>

<script>
(() => {
    // Keys
    const LS_BALANCE = 'dwp_balance_v3';
    const LS_HISTORY = 'dwp_history_v3';
    const LS_TARGET_DAYS = 'dwp_target_days_v3';
    const LS_TARGET_MODE = 'dwp_target_mode_v3';
    const LS_LAST_UNDO = 'dwp_last_undo_v3';
    const LS_CARRYOVER = 'dwp_carryover_v3';
    const LS_DAILY_LIMIT = 'dwp_daily_limit_v3';
    const LS_LAST_CARRYOVER_DATE = 'dwp_last_carryover_date_v3';
    const LS_TARGET_START = 'dwp_target_start_v3';

    // Elements
    const balanceText = el('balanceText');
    const lastChange = el('lastChange');
    const entryCount = el('entryCount');
    const canUndoEl = el('canUndo');
    const carryoverEl = el('carryover');
    const dailyLimitDisplay = el('dailyLimitDisplay');
    const amountInput = el('amount');
    const noteInput = el('note');
    const btnIncome = el('btnIncome');
    const btnExpense = el('btnExpense');
    const btnUndo = el('btnUndo');
    const historyList = el('historyList');
    const targetDaysInput = el('targetDays');
    const targetMode = el('targetMode');
    const targetDisplay = el('targetDisplay');
    const dailyBudgetEl = el('dailyBudget');
    const spentTodayEl = el('spentToday');
    const remainingTodayEl = el('remainingToday');
    const pBar = el('pBar');
    const warningText = el('warningText');
    const snapshotBtn = el('snapshotBtn');
    const quickAddBtn = el('quickAddBtn');
    const quickFloating = el('floatingAdd');
    const btnExport = el('btnExport');
    const btnExportJSON = el('btnExportJSON');
    const btnImport = el('btnImport');
    const importFile = el('importFile');
    const filterType = el('filterType');
    const filterFrom = el('filterFrom');
    const filterTo = el('filterTo');
    const btnApplyFilter = el('btnApplyFilter');
    const btnClearFilter = el('btnClearFilter');
    const setBalanceBtn = el('setBalanceBtn');
    const balanceInput = el('balanceInput');
    const clearAllBtn = el('clearAllBtn');
    const downloadLogsBtn = el('downloadLogsBtn');
    const saveTargetBtn = el('saveTargetBtn');
    const paydayModal = el('paydayModal');
    const paydayDays = el('paydayDays');
    const paydayMode = el('paydayMode');
    const paydayConfirmBtn = el('paydayConfirmBtn');
    const paydaySkipBtn = el('paydaySkipBtn');

    // UI fields introduced
    const origTargetEl = el('origTarget');
    const remainingDaysEstimateEl = el('remainingDaysEstimate');
    const targetStartDateEl = el('targetStartDate');

    // State
    let balance = loadNumber(LS_BALANCE, 0);
    let history = loadJSON(LS_HISTORY, []);
    let lastUndo = loadJSON(LS_LAST_UNDO, null);
    let carryover = loadNumber(LS_CARRYOVER, 0);
    let targetDays = Number(localStorage.getItem(LS_TARGET_DAYS) || 0);
    let targetModeValue = localStorage.getItem(LS_TARGET_MODE) || 'days';
    let fixedDailyLimit = loadNumber(LS_DAILY_LIMIT, 0);
    let targetStartRaw = localStorage.getItem(LS_TARGET_START) || null;

    // Initialize UI
    targetDaysInput.value = targetDays || '';
    targetMode.value = targetModeValue;

    // Listeners
    amountInput.addEventListener('input', onAmountInput);
    amountInput.addEventListener('keydown', onAmountKeyDown);
    btnIncome.addEventListener('click', () => addTransaction('Income'));
    btnExpense.addEventListener('click', () => addTransaction('Expense'));
    btnUndo.addEventListener('click', undoLast);
    snapshotBtn.addEventListener('click', takeSnapshot);
    quickAddBtn.addEventListener('click', quickAddModal);
    quickFloating.addEventListener('click', quickAddModal);
    btnExport.addEventListener('click', exportCSV);
    btnExportJSON.addEventListener('click', () => downloadJSON(history, 'dwp_history.json'));
    btnImport.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', handleImport);
    btnApplyFilter.addEventListener('click', applyFilter);
    btnClearFilter.addEventListener('click', clearFilter);
    setBalanceBtn.addEventListener('click', setBalanceFromAdmin);
    balanceInput.addEventListener('input', onAdminBalanceInput);
    clearAllBtn.addEventListener('click', clearAllData);
    downloadLogsBtn.addEventListener('click', () => downloadJSON(history, 'dwp_history.json'));
    saveTargetBtn.addEventListener('click', saveTargetDays);
    paydayConfirmBtn.addEventListener('click', confirmPayday);
    paydaySkipBtn.addEventListener('click', skipPayday);

    applyCarryoverIfNewDay();
    updateUI();

    // ---------------- Helpers ----------------
    function el(id) { return document.getElementById(id); }
    function loadJSON(key, fallback) { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback } catch(e){ return fallback } }
    function saveJSON(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function loadNumber(key, fallback) { const v = localStorage.getItem(key); return v === null ? fallback : Number(v); }
    function saveNumber(key, value) { localStorage.setItem(key, String(value)); }
    function nowKey(d = new Date()) { return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`; }
    function nowTime(d = new Date()){ return d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); }
    function displayDateTime(d = new Date()){ return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${nowTime(d)}`; }
    function parseRupiah(input) { let s = String(input||'').trim().replace(/[^\d]/g,''); return s === '' ? NaN : Number(s); }
    function formatRupiah(num) { return isNaN(num) ? '0' : Number(num).toLocaleString('id-ID'); }

    function isoToDate(iso) {
        try { return new Date(iso); } catch(e) { return null; }
    }

    function parseDateKey(key) {
        // key format: d/m/yyyy
        try {
            if (!key) return null;
            const parts = String(key).split('/');
            const d = Number(parts[0]), m = Number(parts[1]) - 1, y = Number(parts[2]);
            return new Date(y, m, d);
        } catch (e) { return null; }
    }

    function daysBetween(a, b) {
        const msDay = 24 * 60 * 60 * 1000;
        const ad = new Date(a.getFullYear(), a.getMonth(), a.getDate());
        const bd = new Date(b.getFullYear(), b.getMonth(), b.getDate());
        return Math.max(0, Math.round((bd - ad) / msDay));
    }

    function onAmountInput(e) {
        const numeric = e.target.value.replace(/[^\d]/g,'');
        e.target.value = numeric === '' ? '' : formatRupiah(Number(numeric));
    }
    function onAdminBalanceInput(e) { onAmountInput(e); }
    function onAmountKeyDown(e){ if (e.key === 'Enter') addTransaction('Expense'); }

    // ---------------- Transaction Logic ----------------
    function addTransaction(type) {
        const amtRaw = amountInput.value;
        const amount = parseRupiah(amtRaw);
        const note = (noteInput.value || '').trim() || (type === 'Income' ? 'Income' : 'Expense');

        if (isNaN(amount) || amount <= 0) { alert('Enter a valid amount'); return; }

        // Use today's adaptive available budget (fixedDailyLimit is kept for compatibility but we compute adaptive budget)
        if (type === 'Expense' && fixedDailyLimit > 0) {
            const todayKey = nowKey();
            const spentToday = history.filter(h => h.dateKey === todayKey && h.type === 'Expense').reduce((s,h)=>s+h.amount, 0);
            const availableBudget = getAdaptiveDailyBudget() + carryover;
            const projectedSpend = spentToday + amount;

            if (projectedSpend > availableBudget) {
                const overage = projectedSpend - availableBudget;
                const proceed = confirm(
                    `âš ï¸ WARNING: This expense would exceed your daily budget!\n\n` +
                    `Available Budget (today): Rp ${formatRupiah(availableBudget)}\n` +
                    `Already Spent Today: Rp ${formatRupiah(spentToday)}\n` +
                    `This Expense: Rp ${formatRupiah(amount)}\n` +
                    `Overage: Rp ${formatRupiah(overage)}\n\n` +
                    `Continue anyway?`
                );
                if (!proceed) return;
            }
        }

        const t = {
            id: Date.now(),
            type,
            amount,
            note,
            timestamp: new Date().toISOString(),
            dateKey: nowKey(),
            fullDate: displayDateTime()
        };

        lastUndo = { action: 'add', transaction: t, prevBalance: balance };
        saveJSON(LS_LAST_UNDO, lastUndo);

        balance = balance + (type === 'Income' ? amount : -amount);
        history.push(t);
        persistAll();
        amountInput.value = '';
        noteInput.value = '';
        updateUI();

        if (type === 'Income' && amount > 100000) showPaydayModal();
    }

    function undoLast() {
        const undo = loadJSON(LS_LAST_UNDO, null);
        if (!undo) { alert('No action to undo'); return; }
        if (undo.action === 'add') {
            const idx = history.findIndex(h => h.id === undo.transaction.id);
            if (idx > -1) history.splice(idx,1);
            balance = undo.prevBalance;
            lastUndo = null;
            persistAll();
            updateUI();
            alert('Last transaction undone');
        }
    }

    function takeSnapshot() {
        const t = { id: Date.now(), type: 'Snapshot', amount: balance, note: 'Snapshot', timestamp: new Date().toISOString(), dateKey: nowKey(), fullDate: displayDateTime() };
        history.push(t);
        saveJSON(LS_HISTORY, history);
        updateUI();
        alert('Snapshot recorded');
    }

    function quickAddModal() {
        const v = prompt('Quick add amount (e.g. 50.000)');
        if (!v) return;
        const amount = parseRupiah(v);
        if (isNaN(amount) || amount <= 0) { alert('Invalid amount'); return; }
        const t = { id: Date.now(), type: 'Income', amount, note: 'Quick Add', timestamp: new Date().toISOString(), dateKey: nowKey(), fullDate: displayDateTime() };
        lastUndo = { action:'add', transaction: t, prevBalance: balance };
        saveJSON(LS_LAST_UNDO, lastUndo);
        balance += amount;
        history.push(t);
        persistAll();
        updateUI();
        if (amount > 100000) showPaydayModal();
    }

    // ---------------- Export / Import ----------------
    function exportCSV() {
        if (!history.length) { alert('No logs to export'); return; }
        const header = ['id','type','amount','note','fullDate','timestamp'];
        const rows = history.map(h => [h.id,h.type,h.amount, `"${(h.note||'').replace(/"/g,'""')}"`, h.fullDate, h.timestamp]);
        const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
        downloadFile(csv, 'text/csv', `dwp_history_${Date.now()}.csv`);
    }

    function downloadJSON(obj, filename='data.json') {
        const text = JSON.stringify(obj, null, 2);
        downloadFile(text, 'application/json', filename);
    }

    function downloadFile(text, mime, filename) {
        const b = new Blob([text], {type:mime});
        const url = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function handleImport(e) {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const parsed = JSON.parse(reader.result);
                if (!Array.isArray(parsed)) throw new Error('Expected an array');
                const existingIds = new Set(history.map(h=>h.id));
                parsed.forEach(item => { if (!existingIds.has(item.id)) history.push(item); });
                persistAll(); updateUI(); alert('Import complete');
            } catch(err) { alert('Import failed: ' + err.message); }
        };
        reader.readAsText(f);
        importFile.value = '';
    }

    function applyFilter() {
        const type = filterType.value;
        const from = filterFrom.value ? new Date(filterFrom.value) : null;
        const to = filterTo.value ? new Date(filterTo.value) : null;
        const filtered = history.filter(h => {
            if (type !== 'all' && h.type !== type) return false;
            const dt = new Date(h.timestamp);
            if (from && dt < from) return false;
            if (to) { const toEnd = new Date(to); toEnd.setHours(23,59,59,999); if (dt > toEnd) return false; }
            return true;
        });
        renderHistory(filtered);
    }

    function clearFilter() {
        filterType.value = 'all'; filterFrom.value = ''; filterTo.value = '';
        renderHistory(history.slice().reverse());
    }

    function setBalanceFromAdmin() {
        const val = balanceInput.value;
        const parsed = parseRupiah(val);
        if (isNaN(parsed)) { alert('Invalid number'); return; }
        if (!confirm('Overwrite balance?')) return;
        const before = { id: Date.now()+1, type: 'Snapshot', amount: parsed, note: 'Admin overwrite', timestamp: new Date().toISOString(), dateKey: nowKey(), fullDate: displayDateTime() };
        lastUndo = null; balance = parsed; history.push(before); persistAll(); balanceInput.value = ''; updateUI(); alert('Balance overwritten');
    }

    function clearAllData() {
        if (!confirm('Clear everything?')) return;
        [LS_BALANCE, LS_HISTORY, LS_TARGET_DAYS, LS_TARGET_MODE, LS_LAST_UNDO, LS_CARRYOVER, LS_DAILY_LIMIT, LS_LAST_CARRYOVER_DATE, LS_TARGET_START].forEach(k => localStorage.removeItem(k));
        balance = 0; history = []; lastUndo = null; carryover = 0; targetDays = 0; targetModeValue = 'days'; fixedDailyLimit = 0; targetStartRaw = null;
        updateUI(); alert('All data cleared');
    }

    // ---------------- Carryover (fixed carryover per-day) ----------------
    function applyCarryoverIfNewDay() {
        const currentDate = nowKey();
        const lastCarryoverDate = localStorage.getItem(LS_LAST_CARRYOVER_DATE);
        if (lastCarryoverDate !== currentDate && fixedDailyLimit > 0) {
            // compute spent yesterday using explicit yesterday key
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = `${yesterday.getDate()}/${yesterday.getMonth()+1}/${yesterday.getFullYear()}`;
            const spentYesterday = history.filter(h => h.dateKey === yesterdayKey && h.type === 'Expense').reduce((s, h) => s + h.amount, 0);
            carryover = Math.max(0, fixedDailyLimit - spentYesterday);
            localStorage.setItem(LS_LAST_CARRYOVER_DATE, currentDate);
            persistAll();
        }
    }

    function showPaydayModal() { paydayDays.value = ''; paydayMode.value = 'days'; paydayModal.classList.add('active'); }

    function confirmPayday() {
        const days = Number(paydayDays.value);
        if (isNaN(days) || days <= 0) { alert('Enter valid days'); return; }
        targetDays = days; targetModeValue = paydayMode.value;
        targetDaysInput.value = targetDays; targetMode.value = targetModeValue;
        setTargetStartToday();
        // derive a daily limit that is mathematically true for the new target
        const divisor = targetModeValue === 'monthly' ? targetDays * 30 : targetDays;
        fixedDailyLimit = Math.max(1, Math.floor(balance / Math.max(1, divisor)));
        localStorage.setItem(LS_DAILY_LIMIT, fixedDailyLimit);
        localStorage.setItem(LS_LAST_CARRYOVER_DATE, nowKey());
        carryover = 0; paydayModal.classList.remove('active'); persistAll(); updateUI();
    }

    function skipPayday() { paydayModal.classList.remove('active'); }

    function saveTargetDays() {
        const days = Number(targetDaysInput.value);
        if (isNaN(days) || days < 0) { alert('Enter valid number'); return; }
        targetDays = days; targetModeValue = targetMode.value;
        setTargetStartToday();
        const divisor = targetModeValue === 'monthly' ? targetDays * 30 : targetDays;
        fixedDailyLimit = Math.max(1, Math.floor(balance / Math.max(1, divisor)));
        localStorage.setItem(LS_DAILY_LIMIT, fixedDailyLimit);
        localStorage.setItem(LS_LAST_CARRYOVER_DATE, nowKey());
        carryover = 0; persistAll(); updateUI(); alert('Target saved');
    }

    function setTargetStartToday() {
        const todayIso = new Date().toISOString();
        targetStartRaw = todayIso;
        localStorage.setItem(LS_TARGET_START, todayIso);
    }

    // ---------------- Persistence ----------------
    function persistAll() {
        saveNumber(LS_BALANCE, balance);
        saveJSON(LS_HISTORY, history);
        saveJSON(LS_LAST_UNDO, lastUndo);
        saveNumber(LS_CARRYOVER, carryover);
        saveNumber(LS_DAILY_LIMIT, fixedDailyLimit);
        localStorage.setItem(LS_TARGET_DAYS, String(targetDays));
        localStorage.setItem(LS_TARGET_MODE, targetModeValue);
        if (targetStartRaw) localStorage.setItem(LS_TARGET_START, targetStartRaw);
    }

    // ---------------- Adaptive Targeting / Recalculation (Option C) ----------------
    function computeAverageDailyExpenseSinceStart() {
        if (!targetStartRaw) return null;
        const startDate = isoToDate(targetStartRaw);
        if (!startDate) return null;
        const endDate = new Date();
        const daysElapsed = Math.max(1, daysBetween(startDate, endDate)); // >=1
        // sum expenses from startDate (inclusive)
        const totalExpenses = history.reduce((sum, h) => {
            if (h.type !== 'Expense') return sum;
            const hd = isoToDate(h.timestamp);
            if (!hd) return sum;
            if (hd >= new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate())) {
                return sum + h.amount;
            }
            return sum;
        }, 0);
        // If no expense recorded yet, return null to indicate insufficient data
        if (totalExpenses === 0) return null;
        return totalExpenses / daysElapsed;
    }

    function computeEstimatedRemainingDays() {
        if (balance <= 0) return 0;
        // Prefer historical average since target start if available
        const avg = computeAverageDailyExpenseSinceStart();
        if (avg && avg > 0) {
            const estimate = Math.floor(balance / avg);
            return Math.max(0, estimate);
        }
        // Fallback: if targetDays available, compute remaining using original divisor
        if (targetDays > 0) {
            // If target was in months, convert to days
            const divisor = targetModeValue === 'monthly' ? targetDays * 30 : targetDays;
            // remaining days if following original plan given current balance and original divisor:
            const originalDaily = Math.max(1, Math.floor(balance / Math.max(1, divisor)));
            // If originalDaily > 0, compute how many days that yields
            return Math.max(0, Math.floor(balance / Math.max(1, originalDaily)));
        }
        // last fallback: assume 1 day
        return Math.max(0, Math.floor(balance / 1));
    }

    function getAdaptiveDailyBudget() {
        // daily budget = floor(balance / remainingDays)
        const rem = computeEstimatedRemainingDays();
        if (rem <= 0) return Math.max(0, Math.floor(balance)); // whole balance
        return Math.max(1, Math.floor(balance / Math.max(1, rem)));
    }

    // ---------------- UI Update ----------------
    function updateUI() {
        balanceText.innerText = `Rp ${formatRupiah(balance)}`;
        entryCount.innerText = history.length;
        lastChange.innerText = history.length ? history[history.length-1].fullDate + ' â€¢ ' + (history[history.length-1].note||'') : 'â€”';
        canUndoEl.innerText = loadJSON(LS_LAST_UNDO, null) ? 'Yes' : 'No';
        carryoverEl.innerText = `Rp ${formatRupiah(carryover)}`;
        dailyLimitDisplay.innerText = fixedDailyLimit > 0 ? `Rp ${formatRupiah(fixedDailyLimit)}` : 'â€”';

        if (fixedDailyLimit > 0 || targetDays > 0 || targetStartRaw) {
            targetDisplay.style.display = 'block';
            origTargetEl.innerText = targetDays > 0 ? `${targetDays} ${targetModeValue === 'monthly' ? 'month(s)' : 'day(s)'}` : 'â€”';
            targetStartDateEl.innerText = targetStartRaw ? (new Date(targetStartRaw).toLocaleDateString('id-ID')) : 'â€”';

            const availableBudget = getAdaptiveDailyBudget() + carryover;
            dailyBudgetEl.innerText = `Rp ${formatRupiah(availableBudget)}`;

            const todayKey = nowKey();
            const spentToday = history.filter(h => h.dateKey === todayKey && h.type === 'Expense').reduce((s,h)=>s+h.amount, 0);
            spentTodayEl.innerText = `Rp ${formatRupiah(spentToday)}`;
            remainingTodayEl.innerText = `Rp ${formatRupiah(Math.max(0, availableBudget - spentToday))}`;

            let percent = availableBudget > 0 ? (spentToday / availableBudget) * 100 : 0;
            pBar.style.width = Math.min(percent, 100) + '%';

            if (percent > 100) { pBar.style.background = 'var(--red)'; warningText.innerText = 'OVER LIMIT!'; warningText.style.color = 'var(--red)'; }
            else if (percent > 80) { pBar.style.background = 'var(--yellow)'; warningText.innerText = 'ALMOST FULL'; warningText.style.color = 'var(--yellow)'; }
            else { pBar.style.background = 'var(--green)'; warningText.innerText = 'SAFE'; warningText.style.color = 'var(--green)'; }

            const remDays = computeEstimatedRemainingDays();
            remainingDaysEstimateEl.innerText = (remDays === Infinity || remDays === null) ? 'â€”' : `${remDays} day(s)`;
        } else {
            targetDisplay.style.display = 'none';
        }

        renderHistory(history.slice().reverse());
    }

    function renderHistory(list) {
        historyList.innerHTML = list.slice(0, 200).map(h => {
            const sign = h.type === 'Expense' ? '-' : (h.type === 'Income' ? '+' : '');
            const color = h.type === 'Expense' ? 'color:var(--red)' : (h.type === 'Income' ? 'color:var(--green)' : 'color:var(--accent)');
            return `<li><div><strong>${h.type}</strong><br><div class="note">${h.fullDate} â€¢ ${h.note || ''}</div></div>
                    <div style="${color}; text-align:right; min-width:90px">${sign} Rp ${formatRupiah(h.amount)}
                    <div style="margin-top:6px"><button class="small-btn" onclick="deleteLog(${h.id})">Delete</button></div></div></li>`;
        }).join('');
    }

    // UPDATED: Delete Log with Balance Recalculation
    window.deleteLog = function(id) {
        if (!confirm('Delete this log entry?')) return;
        const idx = history.findIndex(h=>h.id===id);
        if (idx > -1) {
            const deletedTransaction = history[idx];

            if (deletedTransaction.type === 'Income') {
                // removing an income reduces balance by that amount
                balance -= deletedTransaction.amount;
            } else if (deletedTransaction.type === 'Expense') {
                // removing an expense increases balance
                balance += deletedTransaction.amount;
            } else if (deletedTransaction.type === 'Snapshot') {
                // If deleting a snapshot, recompute full balance from transactions excluding that snapshot
                // Recompute from history excluding the snapshot entry
                const remaining = history.filter((h,i) => i !== idx);
                const recomputed = remaining.reduce((sum, h) => {
                    if (h.type === 'Income') return sum + h.amount;
                    if (h.type === 'Expense') return sum - h.amount;
                    return sum;
                }, 0);
                balance = recomputed;
            }

            history.splice(idx, 1);
            persistAll();
            updateUI();
            alert('Log entry deleted and balance updated');
        }
    };

    document.getElementById('floatingToggleAdmin').addEventListener('click', () => {
        const admin = document.getElementById('adminSection');
        admin.style.display = admin.style.display === 'block' ? 'none' : 'block';
    });

    setInterval(() => { persistAll(); }, 15000);
    window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undoLast(); } });
})();
</script>
</body>
</html>