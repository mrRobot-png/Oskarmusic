<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Wallet Pro — Smarter (Option C)</title>
<style>
    :root {
        --bg: #0f1220;
        --card: rgba(255,255,255,0.08);
        --muted: #a0a3bd;
        --accent: #4aa3ff;
        --green: #2ecc71;
        --red: #ff5c5c;
        --yellow: #f1c40f;
        --radius: 14px;
        --maxw: 700px;
    }
    html,body{height:100%;margin:0}
    body {
        background: var(--bg);
        color: #eaeaf0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        padding: 22px;
        display:flex;
        justify-content:center;
        align-items:flex-start;
    }
    .wrap {
        width:100%;
        max-width:var(--maxw);
    }
    .card {
        background: var(--card);
        border-radius: var(--radius);
        padding:16px;
        margin-bottom:14px;
        border:1px solid rgba(255,255,255,0.12);
    }
    h2,h3{margin:0 0 8px;color:var(--accent)}
    .muted{color:var(--muted);font-size:0.9rem}
    .balance {
        font-size:2.2rem;font-weight:700;color:var(--green);
        display:flex;justify-content:space-between;align-items:center;
    }
    .small-btn { padding:6px 10px;border-radius:10px;border:none; cursor:pointer; font-weight:600 }
    .blue { background:var(--accent); color:white }
    .green { background:var(--green); color:#082a12 }
    .red { background:var(--red); color:white }
    input[type="text"], input[type="number"], select {
        width:100%; padding:12px; margin-top:8px; border-radius:10px;
        background: rgba(255,255,255,0.04); color: #fff; border:1px solid rgba(255,255,255,0.12);
        box-sizing:border-box; font-size:1rem;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .progress-container { background: rgba(255,255,255,0.06); border-radius:10px; height:12px; overflow:hidden; margin-top:10px;}
    .progress-bar { height:100%; width:0%; transition:width .25s, background .25s; }
    ul { list-style:none;padding:0;margin:0; max-height:220px; overflow:auto;}
    li { padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .note { color:var(--muted); font-size:0.85rem }
    .floating {
        position:fixed; right:20px; bottom:20px; z-index:9999;
        display:flex; gap:8px; flex-direction:column;
    }
    .chip { padding:8px 12px; border-radius:999px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); }
    .controls { display:flex; gap:10px; margin-top:10px; }
    .filter-row { display:flex; gap:10px; align-items:center; margin-top:8px }
    .small { font-size:0.85rem; padding:6px 10px; border-radius:8px; }
    .danger { background: rgba(255,0,0,0.06); border:1px solid rgba(255,0,0,0.12); color:var(--red); padding:8px;border-radius:10px }
    .center { text-align:center }
    .kbd { background:rgba(0,0,0,0.25); padding:2px 6px; border-radius:6px; font-size:0.8rem; }
    .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center; }
    .modal-overlay.active { display:flex; }
    .modal-content { background:var(--bg); border:1px solid rgba(255,255,255,0.12); border-radius:var(--radius); padding:24px; max-width:400px; width:90%; }
    .modal-content h3 { margin-top:0; }
    .modal-content button { width:100%; margin-top:10px; padding:10px; }
    @media (max-width:520px){ .row{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <div class="muted">Current Balance</div>
                <div class="balance" id="balanceText">Rp 0</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;min-width:180px">
                <button class="small-btn blue" id="snapshotBtn">Take Snapshot</button>
                <button class="small-btn green" id="quickAddBtn">Quick + Balance</button>
            </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <div class="chip muted">Last change: <span id="lastChange">—</span></div>
            <div class="chip muted">Entries: <span id="entryCount">0</span></div>
            <div class="chip muted">Undo: <span id="canUndo">No</span></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <div class="chip muted">Daily Limit: <span id="dailyLimitDisplay">—</span></div>
            <div class="chip muted">Carryover: <span id="carryover">Rp 0</span></div>
        </div>
    </div>

    <div class="card">
        <h3>Target Maker (Adaptive)</h3>
        <p class="muted">How many days must this money last? The app will adapt based on your real spending.</p>
        <div class="row">
            <input type="number" id="targetDays" placeholder="e.g. 9">
            <select id="targetMode" title="target mode">
                <option value="days">Days (divide total)</option>
                <option value="monthly">Months (divide total * 30)</option>
            </select>
        </div>
        <button class="small-btn blue" id="saveTargetBtn" style="width:100%; margin-top:10px;">Save Target Days</button>
        <div id="targetDisplay" class="target-result" style="display:none; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end">
                <div>
                    <span class="muted">Today's Budget: <br><strong id="dailyBudget" style="color:var(--accent); font-size:1.05rem">Rp 0</strong></span>
                </div>
                <div style="text-align:right">
                    <div class="muted" style="font-size:0.9rem">Original Target: <span id="origTarget">—</span></div>
                    <div class="muted" style="font-size:1rem; margin-top:6px">Estimate Remaining Days: <strong id="remainingDaysEstimate">—</strong></div>
                    <div id="warningText" class="muted" style="font-weight:700; margin-top:6px;"></div>
                </div>
            </div>
            <div class="progress-container">
                <div id="pBar" class="progress-bar"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:8px;" class="muted">
                <span>Spent Today: <span id="spentToday">Rp 0</span></span>
                <span>Remaining Today: <span id="remainingToday">Rp 0</span></span>
            </div>
            <div style="margin-top:8px" class="muted">Target started: <span id="targetStartDate">—</span></div>
        </div>
    </div>

    <div class="card" aria-labelledby="addTransactionTitle">
        <h3 id="addTransactionTitle">Add Transaction</h3>
        <div class="row">
            <input type="text" id="amount" inputmode="numeric" placeholder="Amount (e.g. 20.000)" autocomplete="off" />
            <input type="text" id="note" placeholder="Description (optional)" autocomplete="off" />
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="small-btn green" id="btnIncome">Income</button>
            <button class="small-btn red" id="btnExpense">Expense</button>
            <button class="small-btn blue" id="btnUndo" title="Undo last transaction">Undo</button>
        </div>

        <div class="controls" style="margin-top:12px">
            <button class="small-btn" id="btnExport">Export CSV</button>
            <button class="small-btn" id="btnExportJSON">Export JSON</button>
            <input type="file" id="importFile" style="display:none;" accept=".json" />
            <button class="small-btn" id="btnImport">Import JSON</button>
        </div>
    </div>

    <div class="card">
        <h3>History</h3>
        <div class="filter-row">
            <select id="historyFilter" class="small">
                <option value="all">All</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
                <option value="Snapshot">Snapshot</option>
            </select>
            <input type="text" id="searchNote" placeholder="Search description..." class="small" style="flex:1" />
            <button class="small-btn" id="btnClearFilters">Clear</button>
        </div>
        <ul id="historyList"></ul>
    </div>

    <div class="card" id="adminSection" style="display:none">
        <h3 style="color:var(--yellow)">Admin Panel</h3>
        <div class="danger">
            <strong>⚠️ Danger Zone:</strong>
            <p style="margin:4px 0 10px">Actions here cannot be easily undone.</p>
            <button class="small-btn red" id="btnClearAll" style="margin-right:6px">Clear All Data</button>
            <button class="small-btn" id="btnImportReplace">Import & Replace All</button>
        </div>
        <h4 style="margin-top:14px">Set Fixed Daily Limit (Optional)</h4>
        <p class="muted">This sets an immutable daily spending limit. Overrules target calculations if set. Leave blank or zero to rely only on adaptive targeting.</p>
        <input type="number" id="fixedDailyInput" placeholder="e.g. 50.000" />
        <button class="small-btn blue" id="saveFixedDailyBtn" style="width:100%; margin-top:8px">Save Fixed Daily Limit</button>
        <h4 style="margin-top:14px">Carryover Management</h4>
        <p class="muted">Manually adjust leftover budget from previous days.</p>
        <input type="number" id="carryoverInput" placeholder="e.g. 10000" />
        <button class="small-btn blue" id="saveCarryoverBtn" style="width:100%; margin-top:8px">Set Carryover</button>
    </div>

    <div class="floating">
        <button class="small-btn" id="floatingToggleAdmin" style="padding:10px 14px">⚙️ Admin</button>
    </div>

</div>

<div class="modal-overlay" id="quickAddModal">
    <div class="modal-content">
        <h3>Quick Add Balance</h3>
        <p class="muted">Enter a new amount to <strong>set</strong> your total balance directly (not add to it).</p>
        <input type="number" id="quickAddInput" placeholder="e.g. 1000000" style="margin-top:8px" />
        <button class="small-btn green" id="confirmQuickAdd">Set Balance</button>
        <button class="small-btn" id="cancelQuickAdd">Cancel</button>
    </div>
</div>

<script>
(function(){
    "use strict";

    const LS_BALANCE = 'dailyWalletBalance';
    const LS_HISTORY = 'dailyWalletHistory';
    const LS_LAST_UNDO = 'dailyWalletLastUndo';
    const LS_TARGET_DAYS = 'dailyWalletTargetDays';
    const LS_TARGET_MODE = 'dailyWalletTargetMode';
    const LS_TARGET_START = 'dailyWalletTargetStart';
    const LS_CARRYOVER = 'dailyWalletCarryover';
    const LS_DAILY_LIMIT = 'dailyWalletDailyLimit';

    let balance = 0;
    let history = [];
    let lastUndo = null;
    let targetDays = 0;
    let targetModeValue = 'days';
    let targetStartRaw = null;
    let carryover = 0;
    let fixedDailyLimit = 0;

    const balanceText = document.getElementById('balanceText');
    const entryCount = document.getElementById('entryCount');
    const lastChange = document.getElementById('lastChange');
    const canUndoEl = document.getElementById('canUndo');
    const carryoverEl = document.getElementById('carryover');
    const dailyLimitDisplay = document.getElementById('dailyLimitDisplay');
    const targetDisplay = document.getElementById('targetDisplay');
    const dailyBudgetEl = document.getElementById('dailyBudget');
    const spentTodayEl = document.getElementById('spentToday');
    const remainingTodayEl = document.getElementById('remainingToday');
    const origTargetEl = document.getElementById('origTarget');
    const remainingDaysEstimateEl = document.getElementById('remainingDaysEstimate');
    const targetStartDateEl = document.getElementById('targetStartDate');
    const pBar = document.getElementById('pBar');
    const warningText = document.getElementById('warningText');
    const historyList = document.getElementById('historyList');

    const amountInput = document.getElementById('amount');
    const noteInput = document.getElementById('note');
    const btnIncome = document.getElementById('btnIncome');
    const btnExpense = document.getElementById('btnExpense');
    const btnUndo = document.getElementById('btnUndo');
    const btnExport = document.getElementById('btnExport');
    const btnExportJSON = document.getElementById('btnExportJSON');
    const btnImport = document.getElementById('btnImport');
    const importFile = document.getElementById('importFile');
    const btnClearAll = document.getElementById('btnClearAll');
    const btnImportReplace = document.getElementById('btnImportReplace');

    const snapshotBtn = document.getElementById('snapshotBtn');
    const quickAddBtn = document.getElementById('quickAddBtn');
    const quickAddModal = document.getElementById('quickAddModal');
    const confirmQuickAdd = document.getElementById('confirmQuickAdd');
    const cancelQuickAdd = document.getElementById('cancelQuickAdd');
    const quickAddInput = document.getElementById('quickAddInput');

    const targetDaysInput = document.getElementById('targetDays');
    const targetModeSelect = document.getElementById('targetMode');
    const saveTargetBtn = document.getElementById('saveTargetBtn');

    const historyFilter = document.getElementById('historyFilter');
    const searchNote = document.getElementById('searchNote');
    const btnClearFilters = document.getElementById('btnClearFilters');

    const fixedDailyInput = document.getElementById('fixedDailyInput');
    const saveFixedDailyBtn = document.getElementById('saveFixedDailyBtn');
    const carryoverInput = document.getElementById('carryoverInput');
    const saveCarryoverBtn = document.getElementById('saveCarryoverBtn');

    // ---------------- Helpers ----------------
    function saveNumber(key, val) { localStorage.setItem(key, String(val)); }
    function loadNumber(key, def) { const v = localStorage.getItem(key); return (v && !isNaN(v)) ? Number(v) : def; }
    function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    function loadJSON(key, def) { const v = localStorage.getItem(key); try { return v ? JSON.parse(v) : def; } catch { return def; } }
    function formatRupiah(n) { return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, '.'); }
    function parseRupiah(str) {
        const cleaned = str.replace(/\./g, '').replace(/[^\d]/g, '');
        const num = parseInt(cleaned, 10);
        return isNaN(num) ? 0 : num;
    }
    function nowKey() {
        const now = new Date();
        return now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
    }
    function nowDateTime() {
        const now = new Date();
        const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
        const h=String(now.getHours()).padStart(2,'0'), min=String(now.getMinutes()).padStart(2,'0'), s=String(now.getSeconds()).padStart(2,'0');
        return `${y}-${m}-${d} ${h}:${min}:${s}`;
    }
    function daysBetween(d1, d2) {
        const ms = d2 - d1;
        return Math.floor(ms / (1000*60*60*24));
    }
    function isoToDate(iso) {
        const dt = new Date(iso);
        return isNaN(dt.getTime()) ? null : dt;
    }

    // ---------------- Initialization ----------------
    function init() {
        balance = loadNumber(LS_BALANCE, 0);
        history = loadJSON(LS_HISTORY, []);
        lastUndo = loadJSON(LS_LAST_UNDO, null);
        carryover = loadNumber(LS_CARRYOVER, 0);
        fixedDailyLimit = loadNumber(LS_DAILY_LIMIT, 0);
        targetDays = loadNumber(LS_TARGET_DAYS, 0);
        targetModeValue = localStorage.getItem(LS_TARGET_MODE) || 'days';
        targetStartRaw = localStorage.getItem(LS_TARGET_START) || null;

        targetDaysInput.value = targetDays > 0 ? targetDays : '';
        targetModeSelect.value = targetModeValue;
        fixedDailyInput.value = fixedDailyLimit > 0 ? fixedDailyLimit : '';
        carryoverInput.value = carryover;

        updateUI();
    }

    // ---------------- Actions ----------------
    function addTransaction(type) {
        const rawAmt = amountInput.value.trim();
        if (!rawAmt) { alert('Please enter an amount'); return; }
        const amt = parseRupiah(rawAmt);
        if (amt <= 0) { alert('Amount must be positive'); return; }
        const note = noteInput.value.trim();

        const entry = {
            id: Date.now(),
            type,
            amount: amt,
            note,
            dateKey: nowKey(),
            fullDate: nowDateTime(),
            timestamp: new Date().toISOString()
        };

        lastUndo = { balance, entry };
        saveJSON(LS_LAST_UNDO, lastUndo);

        if (type === 'Income') balance += amt;
        else if (type === 'Expense') balance -= amt;

        history.push(entry);
        persistAll();
        updateUI();
        amountInput.value = '';
        noteInput.value = '';
    }

    function undoLast() {
        const undo = loadJSON(LS_LAST_UNDO, null);
        if (!undo) { alert('Nothing to undo'); return; }
        balance = undo.balance;
        const idx = history.findIndex(h => h.id === undo.entry.id);
        if (idx > -1) history.splice(idx, 1);
        localStorage.removeItem(LS_LAST_UNDO);
        persistAll();
        updateUI();
        alert('Last action undone');
    }

    function takeSnapshot() {
        const note = prompt('Note for snapshot (optional):') || '';
        const entry = {
            id: Date.now(),
            type: 'Snapshot',
            amount: balance,
            note,
            dateKey: nowKey(),
            fullDate: nowDateTime(),
            timestamp: new Date().toISOString()
        };
        history.push(entry);
        persistAll();
        updateUI();
        alert('Snapshot saved!');
    }

    function quickAddBalance() {
        quickAddModal.classList.add('active');
    }
    function confirmQuickAddFn() {
        const val = quickAddInput.value.trim();
        if (!val) { alert('Enter a value'); return; }
        const newBal = parseRupiah(val);
        if (newBal < 0) { alert('Must be non-negative'); return; }
        balance = newBal;
        persistAll();
        updateUI();
        quickAddModal.classList.remove('active');
        quickAddInput.value = '';
        alert('Balance updated!');
    }
    function cancelQuickAddFn() {
        quickAddModal.classList.remove('active');
        quickAddInput.value = '';
    }

    function saveTargetDaysFn() {
        const val = targetDaysInput.value.trim();
        targetDays = (val && !isNaN(val)) ? Math.max(0, parseInt(val,10)) : 0;
        targetModeValue = targetModeSelect.value;
        initTargetStart();
        persistAll();
        updateUI();
        alert('Target saved!');
    }

    function saveFixedDailyLimitFn() {
        const val = fixedDailyInput.value.trim();
        fixedDailyLimit = (val && !isNaN(val)) ? Math.max(0, parseInt(val,10)) : 0;
        persistAll();
        updateUI();
        alert('Fixed daily limit saved!');
    }

    function saveCarryoverFn() {
        const val = carryoverInput.value.trim();
        carryover = (val && !isNaN(val)) ? parseInt(val,10) : 0;
        persistAll();
        updateUI();
        alert('Carryover saved!');
    }

    function exportCSV() {
        if (!history.length) { alert('No data to export'); return; }
        let csv = 'Type,Amount,Note,Date\n';
        history.forEach(h => {
            const escaped = (h.note || '').replace(/"/g, '""');
            csv += `${h.type},${h.amount},"${escaped}",${h.fullDate}\n`;
        });
        downloadFile('wallet-export.csv', csv, 'text/csv');
    }

    function exportJSON() {
        const data = { balance, history, carryover, fixedDailyLimit, targetDays, targetModeValue, targetStartRaw };
        const json = JSON.stringify(data, null, 2);
        downloadFile('wallet-export.json', json, 'application/json');
    }

    function importJSON() {
        importFile.click();
    }

    function handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const data = JSON.parse(ev.target.result);
                balance = data.balance || 0;
                history = data.history || [];
                carryover = data.carryover || 0;
                fixedDailyLimit = data.fixedDailyLimit || 0;
                targetDays = data.targetDays || 0;
                targetModeValue = data.targetModeValue || 'days';
                targetStartRaw = data.targetStartRaw || null;
                persistAll();
                updateUI();
                alert('Data imported successfully!');
            } catch (err) {
                alert('Import failed: invalid JSON');
            }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if (!confirm('Clear all data? This cannot be undone.')) return;
        localStorage.clear();
        location.reload();
    }

    function importReplace() {
        if (!confirm('This will replace ALL your data. Continue?')) return;
        importJSON();
    }

    function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ---------------- Event Listeners ----------------
    btnIncome.addEventListener('click', () => addTransaction('Income'));
    btnExpense.addEventListener('click', () => addTransaction('Expense'));
    btnUndo.addEventListener('click', undoLast);
    snapshotBtn.addEventListener('click', takeSnapshot);
    quickAddBtn.addEventListener('click', quickAddBalance);
    confirmQuickAdd.addEventListener('click', confirmQuickAddFn);
    cancelQuickAdd.addEventListener('click', cancelQuickAddFn);
    saveTargetBtn.addEventListener('click', saveTargetDaysFn);
    saveFixedDailyBtn.addEventListener('click', saveFixedDailyLimitFn);
    saveCarryoverBtn.addEventListener('click', saveCarryoverFn);
    btnExport.addEventListener('click', exportCSV);
    btnExportJSON.addEventListener('click', exportJSON);
    btnImport.addEventListener('click', importJSON);
    importFile.addEventListener('change', handleImport);
    btnClearAll.addEventListener('click', clearAllData);
    btnImportReplace.addEventListener('click', importReplace);

    historyFilter.addEventListener('change', updateUI);
    searchNote.addEventListener('input', updateUI);
    btnClearFilters.addEventListener('click', () => {
        historyFilter.value = 'all';
        searchNote.value = '';
        updateUI();
    });

    function initTargetStart() {
        if (targetStartRaw) return;
        const todayIso = new Date().toISOString();
        targetStartRaw = todayIso;
        localStorage.setItem(LS_TARGET_START, todayIso);
    }

    // ---------------- Persistence ----------------
    function persistAll() {
        saveNumber(LS_BALANCE, balance);
        saveJSON(LS_HISTORY, history);
        saveJSON(LS_LAST_UNDO, lastUndo);
        saveNumber(LS_CARRYOVER, carryover);
        saveNumber(LS_DAILY_LIMIT, fixedDailyLimit);
        localStorage.setItem(LS_TARGET_DAYS, String(targetDays));
        localStorage.setItem(LS_TARGET_MODE, targetModeValue);
        if (targetStartRaw) localStorage.setItem(LS_TARGET_START, targetStartRaw);
    }

    // ---------------- Adaptive Targeting / Recalculation (Option C) ----------------
    function computeAverageDailyExpenseSinceStart() {
        if (!targetStartRaw) return null;
        const startDate = isoToDate(targetStartRaw);
        if (!startDate) return null;
        const endDate = new Date();
        const daysElapsed = Math.max(1, daysBetween(startDate, endDate)); // >=1
        // sum expenses from startDate (inclusive)
        const totalExpenses = history.reduce((sum, h) => {
            if (h.type !== 'Expense') return sum;
            const hd = isoToDate(h.timestamp);
            if (!hd) return sum;
            if (hd >= new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate())) {
                return sum + h.amount;
            }
            return sum;
        }, 0);
        // If no expense recorded yet, return null to indicate insufficient data
        if (totalExpenses === 0) return null;
        return totalExpenses / daysElapsed;
    }

    function computeEstimatedRemainingDays() {
        if (balance <= 0) return 0;
        // Prefer historical average since target start if available
        const avg = computeAverageDailyExpenseSinceStart();
        if (avg && avg > 0) {
            const estimate = Math.floor(balance / avg);
            return Math.max(0, estimate);
        }
        // Fallback: if targetDays available, compute remaining using original divisor
        if (targetDays > 0) {
            // If target was in months, convert to days
            const divisor = targetModeValue === 'monthly' ? targetDays * 30 : targetDays;
            // remaining days if following original plan given current balance and original divisor:
            const originalDaily = Math.max(1, Math.floor(balance / Math.max(1, divisor)));
            // If originalDaily > 0, compute how many days that yields
            return Math.max(0, Math.floor(balance / Math.max(1, originalDaily)));
        }
        // last fallback: assume 1 day
        return Math.max(0, Math.floor(balance / 1));
    }

    function getAdaptiveDailyBudget() {
        // daily budget = floor(balance / remainingDays)
        const rem = computeEstimatedRemainingDays();
        if (rem <= 0) return Math.max(0, Math.floor(balance)); // whole balance
        return Math.max(1, Math.floor(balance / Math.max(1, rem)));
    }

    // ---------------- UI Update ----------------
    function updateUI() {
        balanceText.innerText = `Rp ${formatRupiah(balance)}`;
        entryCount.innerText = history.length;
        lastChange.innerText = history.length ? history[history.length-1].fullDate + ' • ' + (history[history.length-1].note||'') : '—';
        canUndoEl.innerText = loadJSON(LS_LAST_UNDO, null) ? 'Yes' : 'No';
        carryoverEl.innerText = `Rp ${formatRupiah(carryover)}`;
        dailyLimitDisplay.innerText = fixedDailyLimit > 0 ? `Rp ${formatRupiah(fixedDailyLimit)}` : '—';

        if (fixedDailyLimit > 0 || targetDays > 0 || targetStartRaw) {
            targetDisplay.style.display = 'block';
            origTargetEl.innerText = targetDays > 0 ? `${targetDays} ${targetModeValue === 'monthly' ? 'month(s)' : 'day(s)'}` : '—';
            targetStartDateEl.innerText = targetStartRaw ? (new Date(targetStartRaw).toLocaleDateString('id-ID')) : '—';

            const availableBudget = getAdaptiveDailyBudget() + carryover;
            dailyBudgetEl.innerText = `Rp ${formatRupiah(availableBudget)}`;

            const todayKey = nowKey();
            const spentToday = history.filter(h => h.dateKey === todayKey && h.type === 'Expense').reduce((s,h)=>s+h.amount, 0);
            spentTodayEl.innerText = `Rp ${formatRupiah(spentToday)}`;
            remainingTodayEl.innerText = `Rp ${formatRupiah(Math.max(0, availableBudget - spentToday))}`;

            let percent = availableBudget > 0 ? (spentToday / availableBudget) * 100 : 0;
            pBar.style.width = Math.min(percent, 100) + '%';

            if (percent > 100) { pBar.style.background = 'var(--red)'; warningText.innerText = 'OVER LIMIT!'; warningText.style.color = 'var(--red)'; }
            else if (percent > 80) { pBar.style.background = 'var(--yellow)'; warningText.innerText = 'ALMOST FULL'; warningText.style.color = 'var(--yellow)'; }
            else { pBar.style.background = 'var(--green)'; warningText.innerText = 'SAFE'; warningText.style.color = 'var(--green)'; }

            const remDays = computeEstimatedRemainingDays();
            remainingDaysEstimateEl.innerText = (remDays === Infinity || remDays === null) ? '—' : `${remDays} day(s)`;
        } else {
            targetDisplay.style.display = 'none';
        }

        // Apply filters
        let filtered = history.slice();
        const filterType = historyFilter.value;
        if (filterType !== 'all') {
            filtered = filtered.filter(h => h.type === filterType);
        }
        const searchTerm = searchNote.value.trim().toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(h => (h.note || '').toLowerCase().includes(searchTerm));
        }

        renderHistory(filtered.slice().reverse());
    }

    function renderHistory(list) {
        historyList.innerHTML = list.slice(0, 200).map(h => {
            const sign = h.type === 'Expense' ? '-' : (h.type === 'Income' ? '+' : '');
            const color = h.type === 'Expense' ? 'color:var(--red)' : (h.type === 'Income' ? 'color:var(--green)' : 'color:var(--accent)');
            return `<li><div><strong>${h.type}</strong><br><div class="note">${h.fullDate} • ${h.note || ''}</div></div>
                    <div style="${color}; text-align:right; min-width:90px">${sign} Rp ${formatRupiah(h.amount)}
                    <div style="margin-top:6px"><button class="small-btn" onclick="deleteLog(${h.id})">Delete</button></div></div></li>`;
        }).join('');
    }

    // UPDATED: Delete Log with Balance Recalculation
    window.deleteLog = function(id) {
        if (!confirm('Delete this log entry?')) return;
        const idx = history.findIndex(h=>h.id===id);
        if (idx > -1) {
            const deletedTransaction = history[idx];

            if (deletedTransaction.type === 'Income') {
                // removing an income reduces balance by that amount
                balance -= deletedTransaction.amount;
            } else if (deletedTransaction.type === 'Expense') {
                // removing an expense increases balance
                balance += deletedTransaction.amount;
            } else if (deletedTransaction.type === 'Snapshot') {
                // If deleting a snapshot, recompute full balance from transactions excluding that snapshot
                // Recompute from history excluding the snapshot entry
                const remaining = history.filter((h,i) => i !== idx);
                const recomputed = remaining.reduce((sum, h) => {
                    if (h.type === 'Income') return sum + h.amount;
                    if (h.type === 'Expense') return sum - h.amount;
                    return sum;
                }, 0);
                balance = recomputed;
            }

            history.splice(idx, 1);
            persistAll();
            updateUI();
            alert('Log entry deleted and balance updated');
        }
    };

    document.getElementById('floatingToggleAdmin').addEventListener('click', () => {
        const admin = document.getElementById('adminSection');
        admin.style.display = admin.style.display === 'block' ? 'none' : 'block';
    });

    init();
    setInterval(() => { persistAll(); }, 15000);
    window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undoLast(); } });
})();
</script>
</body>
</html>
